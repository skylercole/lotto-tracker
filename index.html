<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jackpot Value Dashboard</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #4caf50; --danger: #ef5350; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        h1 { margin-bottom: 30px; letter-spacing: 1px; }
        .controls {
            display: flex; justify-content: center; align-items: center; gap: 12px;
            margin: 0 auto 24px; max-width: 1200px;
        }
        .control-group {
            display: flex; align-items: center; gap: 10px;
            background: var(--card); border: 1px solid #2a2a2a; border-radius: 14px;
            padding: 10px 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .control-group label { color: #9e9e9e; font-size: 0.9rem; }
        .control-group select {
            appearance: none; background: #151515; color: var(--text);
            border: 1px solid #333; border-radius: 10px; padding: 8px 34px 8px 12px;
            font-size: 0.95rem; cursor: pointer; outline: none;
            background-image: linear-gradient(45deg, transparent 50%, #888 50%), linear-gradient(135deg, #888 50%, transparent 50%);
            background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
            background-size: 6px 6px, 6px 6px; background-repeat: no-repeat;
        }
        .control-group select:focus { border-color: #4caf50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.15); }
        .grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { 
            background: var(--card); border-radius: 16px; padding: 25px; width: 300px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s; border-top: 5px solid #555;
        }
        .card:hover { transform: translateY(-5px); }
        .jackpot { font-size: 2.2rem; font-weight: bold; margin: 15px 0; color: #fff; }
        .game-logo { width: 120px; height: 48px; object-fit: contain; margin: 0 auto 10px; display: block; }
        .roi-badge { 
            display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: bold; margin-bottom: 20px;
        }
        .good { background: rgba(76, 175, 80, 0.2); color: #66bb6a; border: 1px solid #4caf50; }
        .mid { background: rgba(255, 193, 7, 0.2); color: #ffd54f; border: 1px solid #ffca28; }
        .bad { background: rgba(244, 67, 54, 0.2); color: #ef5350; border: 1px solid #e57373; }
        
        .stat-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .stat-row:last-child { border: none; }
        .label { color: #888; }
        .timestamp { margin-top: 40px; color: #555; font-size: 0.8rem; }
        .footer { margin-top: 24px; font-size: 0.85rem; color: #666; }
        .footer a { color: #8ab4f8; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>

    <h1>Jackpot Value Dashboard</h1>
    <div class="controls">
        <div class="control-group">
            <label for="sort-select">Sort by</label>
            <select id="sort-select">
                <option value="total-roi">Total ROI</option>
                <option value="jackpot">Jackpot Size</option>
            </select>
        </div>
    </div>
    <div id="app" class="grid">
        <p>Loading market data...</p>
    </div>
    <div class="timestamp" id="last-updated"></div>
    <div class="footer">
        <a id="feedback-link" href="#" target="_blank" rel="noopener">Leave feedback</a>
    </div>

    <script>
        // Google Forms (replace with your live form URLs)
        const FEEDBACK_FORM_URL = "https://forms.gle/jWRDuhSsNjv4ESK76";
        // Privacy-friendly analytics (replace with your GoatCounter URL)
        const GOATCOUNTER_URL = "https://thracion.goatcounter.com/count";

        async function loadData() {
            try {
                // TRICK: Add "?t=" + current timestamp
                // Browser sees: "lottery_data.json?t=1769251023456"
                // Since the number changes every second, the browser MUST fetch a fresh copy.
                const url = `lottery_data.json?t=${new Date().getTime()}`;
                
                // EXTRA SAFETY: Tell the fetch API explicitly "no caching"
                const response = await fetch(url, { cache: "no-store" });
                
                if (!response.ok) throw new Error("File not found");
                
                const data = await response.json();
                render(data);
            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('app').innerHTML = "<p>Could not load data.</p>";
            }
        }

        function calculateMetrics(game) {
            // 1. Jackpot EV (Jackpot / Odds)
            const jackpotEV = game.jackpot / game.odds_jackpot;
            
            // 2. Base EV (Expected return from smaller prizes)
            // Price * RTP for non-jackpot tiers
            const baseEV = game.price * game.base_rtp;
            
            // 3. Total EV
            const totalEV = jackpotEV + baseEV;

            // 4. ROIs
            const jackpotROI = ((jackpotEV / game.price) * 100).toFixed(1);
            const totalROI = ((totalEV / game.price) * 100).toFixed(1); // Usually expressed as Return % (e.g. 80%)

            return { jackpotROI, totalROI };
        }

        function formatInternationalDate(dateTime) {
            if (!dateTime) return '';
            if (dateTime === 'Unknown') return dateTime;
            const datePart = dateTime.split(' ')[0];
            const parsed = new Date(datePart);
            if (Number.isNaN(parsed.getTime())) return datePart;
            return new Intl.DateTimeFormat('en-GB', { day: 'numeric', month: 'long' }).format(parsed);
        }

        function formatInternationalDateTime(dateTime) {
            if (!dateTime) return '';
            const normalized = dateTime.replace(' ', 'T');
            const parsed = new Date(normalized);
            if (Number.isNaN(parsed.getTime())) return dateTime;
            return new Intl.DateTimeFormat('en-GB', {
                day: 'numeric',
                month: 'long',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).format(parsed);
        }

        function makeLogo(label, background, foreground) {
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="240" height="96" viewBox="0 0 240 96">
                    <rect width="240" height="96" rx="16" fill="${background}"/>
                    <text x="120" y="58" font-family="Segoe UI, Arial, sans-serif" font-size="28" font-weight="700" text-anchor="middle" fill="${foreground}">
                        ${label}
                    </text>
                </svg>
            `;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function getGameImage(gameName) {
            const key = (gameName || '').toLowerCase();
            if (key.includes('eurojackpot')) return makeLogo('EUROJACKPOT', '#f1c40f', '#1c1c1c');
            if (key.includes('euromillions')) return makeLogo('EUROMILLIONS', '#1e88e5', '#ffd54f');
            if (key.includes('viking')) return makeLogo('VIKINGLOTTO', '#2196f3', '#ffffff');
            if (key.includes('powerball')) return makeLogo('POWERBALL', '#e53935', '#ffffff');
            if (key.includes('mega millions')) return makeLogo('MEGA MILLIONS', '#1565c0', '#ffffff');
            if (key.includes('finnish lotto') || key.includes('lotto')) return makeLogo('FINNISH LOTTO', '#ef5350', '#ffffff');
            return makeLogo('LOTTO', '#ef5350', '#ffffff');
        }

        function render(data) {
            const container = document.getElementById('app');
            container.innerHTML = '';
            
            const updatedDate = formatInternationalDateTime(data.last_updated);
            document.getElementById('last-updated').innerText = "Last Updated: " + updatedDate + " (UTC)";
            const feedbackLink = document.getElementById('feedback-link');
            if (FEEDBACK_FORM_URL && !FEEDBACK_FORM_URL.includes("FORM_ID")) {
                feedbackLink.href = FEEDBACK_FORM_URL;
            } else {
                feedbackLink.href = "#";
                feedbackLink.title = "Set FEEDBACK_FORM_URL to enable feedback";
            }

            const sortMode = window.currentSortMode || "total-roi";
            const viewModels = data.games.map(game => {
                const metrics = calculateMetrics(game);
                return {
                    game,
                    metrics,
                    totalROIValue: parseFloat(metrics.totalROI),
                    jackpotValue: game.jackpot
                };
            });

            if (sortMode === "jackpot") {
                viewModels.sort((a, b) => b.jackpotValue - a.jackpotValue);
            } else {
                viewModels.sort((a, b) => b.totalROIValue - a.totalROIValue);
            }

            viewModels.forEach(({ game, metrics }) => {
                const isPositive = parseFloat(metrics.totalROI) > 100;
                const badgeClass = isPositive ? 'good' : (metrics.totalROI > 60 ? 'mid' : 'bad');
                const nameKey = (game.name || '').toLowerCase();
                const borderColor = isPositive ? '#4caf50' : (
                    nameKey.includes('eurojackpot') ? '#e6b800' :
                    nameKey.includes('euromillions') ? '#1e88e5' :
                    nameKey.includes('powerball') ? '#e53935' :
                    nameKey.includes('mega millions') ? '#1565c0' :
                    nameKey.includes('viking') ? '#2196f3' :
                    '#ef5350'
                );

                const html = `
                    <div class="card" style="border-top-color: ${borderColor}">
                        <img class="game-logo" src="${getGameImage(game.name)}" alt="${game.name} logo" />
                        <!-- <h3>${game.name}</h3> -->
                        <div class="jackpot">€${(game.jackpot / 1000000).toFixed(1)}M</div>
                        <div class="roi-badge ${badgeClass}">
                            Total ROI: ${metrics.totalROI}%
                        </div>
                        
                        <div class="stat-row">
                            <span class="label">Jackpot Only ROI</span>
                            <span>${metrics.jackpotROI}%</span>
                        </div>
                        <div class="stat-row">
                            <span class="label">Ticket Price</span>
                            <span>€${game.price.toFixed(2)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="label">Next Draw</span>
                            <span>${formatInternationalDate(game.next_draw)}</span>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        const sortSelect = document.getElementById('sort-select');
        window.currentSortMode = sortSelect.value;
        sortSelect.addEventListener('change', () => {
            window.currentSortMode = sortSelect.value;
            loadData();
        });

        function trackVisit() {
            if (!GOATCOUNTER_URL || GOATCOUNTER_URL.includes("YOURCODE")) return;
            const img = new Image();
            const url = new URL(GOATCOUNTER_URL);
            url.searchParams.set("p", window.location.pathname);
            url.searchParams.set("t", document.title);
            img.src = url.toString();
        }

        loadData();
        trackVisit();
    </script>
</body>
</html>